#!/usr/bin/python
# -*- coding: utf-8 -*-
# glenn@sensepost.com 
# Snoopy // 2012
# By using this code you agree to abide by the supplied LICENSE.txt

import sys
import os
from MaltegoTransform import *
import logging
import datetime
from time import strftime
from datetime import datetime
import re
from sqlalchemy import *
logging.basicConfig(level=logging.DEBUG,filename='/tmp/maltego_logs.txt',format='%(asctime)s %(levelname)s: %(message)s',datefmt='%Y-%m-%d %H:%M:%S')

def main():
#    print "Content-type: xml\n\n";
#    MaltegoXML_in = sys.stdin.read()
#    logging.debug(MaltegoXML_in)
#    if MaltegoXML_in <> '':
#     m = MaltegoMsg(MaltegoXML_in)

    TRX = MaltegoTransform()
    TRX = MaltegoTransform()
    TRX.parseArguments(sys.argv)

    drone = TRX.getVar("drone")
    location = TRX.getVar("location")
    start_time = TRX.getVar("start_time")
    end_time = TRX.getVar("end_time")
    mac = TRX.getVar("mac")
    ssid = TRX.getVar("ssid")

    filters = []
    s = select([proxs], and_(*filters))    

    if start_time is not None:
        filters.append(proxs.c.start_time >= start_time)
    if end_time is not None:
        filters.append(proxs.c.end_time <= end_time)
    if drone is not None:
        filters.append(proxs.c.drone == drone)
    if location is not None:
        filters.append(proxs.c.location == location)
    if mac is not None:
        filters.append(proxs.c.mac == mac)
    if ssid is not None:
        filters.append(ssids.c.ssid == ssid)

    st_epoch = datetime.strptime(start_time,"%Y-%m-%d %H:%M:%S.%f").strftime('%s')   
    et_epoch = datetime.strptime(end_time,"%Y-%m-%d %H:%M:%S.%f").strftime('%s')

    dbms="sqlite:////root/snoopy_ng/snoopy.db" 
    db = create_engine(dbms)
    metadata = MetaData(db)   
    metadata.reflect()
    #db.echo = True
    proxs = metadata.tables['proximity_sessions']
    #Note: We filter for num_probes > 1 to try remove garbled results (i.e. random MACs) from tcpdump
    s = select([proxs.c.location], and_(proxs.c.drone == drone, proxs.c.first_obs >= st_epoch, proxs.c.last_obs <= et_epoch, proxs.c.num_probes>1)).distinct()
    r = db.execute(s)
    results = r.fetchall()

    for location in results:
        location = location[0]
        NewEnt=TRX.addEntity("snoopy.DroneLocation", location)
        NewEnt.addAdditionalFields("location","location", "strict", "location")
        NewEnt.addAdditionalFields("start_time", "start_time", "strict", start_time)
        NewEnt.addAdditionalFields("end_time", "end_time", "strict", end_time)
    TRX.returnOutput()		

main()
#me = MaltegoTransform()
#me.addEntity("maltego.Phrase","hello bob")
#me.returnOutput()                
